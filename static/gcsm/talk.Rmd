---
title: "Development of a generic composite measure of association between geospatial variables"
author: "Yadong Liu"
institute: "Crop Ecology & Eco Informatics Lab, SNU"
date: "2019/08/28"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warnings=FALSE)
library(tidyverse)
library(latex2exp)
```

# Background

A single metric can not fully characterize the fit between the predicted and observed data.

```{r, fig.show='hold',out.width='50%'}
set.seed(2019)
noise <- rnorm(81,0,0.02)
set.seed(2019)
noise2 <- rnorm(81,0,0.03)
tb1 <- tibble(x=seq(0.4,0.8,length.out=81),y=x-0.2+noise)
tb3 <- tibble(x=seq(0.4,0.8,length.out=81),y=x*1.5-0.3+noise2)
tb1 %>% 
  ggplot()+aes(x,y)+
  geom_point()+geom_abline()+
  annotate(geom='text',x=0.75,y=0.3,label='r==0.987',parse=T,size=8)+
  xlim(0,1)+ylim(0,1)+
  theme_bw(14)
tb3 %>% 
  ggplot()+aes(x,y)+
  geom_point()+geom_abline()+
  annotate(geom='text',x=0.75,y=0.3,label='r==0.987',parse=T,size=8)+
  xlim(0,1)+ylim(0,1)+
  theme_bw(14)
```

---
# Composite measures

- Strctural Similarity (SSIM)

- Composite similarity measure based on Means, Standard deviations and Correlation coefficient (CMSC)

$$S(x, y)=s_{1}(x, y) \cdot s_{2}(x, y) \cdot s_{3}(x, y)$$

Developed for image quality assessment and have been suggested as a diagnostic tool for spatial modeling.

Natively defined with the moving window.

---
# Calculation of SSIM and CMSC

```{r}
eqns <- read_csv('equation.csv')
eqns %>% knitr::kable(format='html',escape=FALSE)
```


---
# Limitations

1. SSIM requires both variabels have the same sign, which is resolved by its variant CMSC.

2. CMSC uses the squared Euclidean distance which leads to a nonlinear responce curve.

3. Poor performance for variables that negatively correlated.

4. Can not compare variables with different scales.

---
# Generic composite similarity measure (GCSM)

$$s_{1}=\left\{\begin{array}{ll}{1-\frac{\left|\mu_{x}-\mu_{y}\right|}{max-min}} & \text{ if }{s_{3}>0}; \\ {1-\frac{\left|min+max-\mu_{x}-\mu_{y}\right|}{max-min}} & \text{ if }{s_{3}<0}.\end{array}\right.$$

$$s_{2}=1-\frac{\left|\sigma_{x}-\sigma_{y}\right|}{(max-min)/2}$$


$$s_{3}=\left\{\begin{array}{ll}{1} & \text{ if } {\sigma_{x}=\sigma_{y}=0}; \\ 
{0} & \text{ if } {\sigma_{x}=0 \text { or } \sigma_{y}=0}; \\ 
{\frac{\sigma_{x y}}{\sigma_{x} \sigma_{y}}} & {\text { otherwise. }}\end{array}\right.$$

---
# Use the original Euclidean distance

```{r, fig.align='center'}
tibble(diff=seq(0,1,length.out=256),cmsc=1-diff^2,gcsm=1-diff) %>% 
  rename_at(-1, toupper) %>% gather(measure,s1,-1) %>% 
  ggplot()+aes(diff,s1,color=measure)+
  geom_line()+
  coord_cartesian(expand=F)+
  labs(x=TeX('$\\frac{\\left|\\mu_{x}-\\mu_{y}\\right|$}{max-min}'),y=TeX('s_1'))+
  theme_bw(14)+
  theme(legend.title=element_blank())+
  theme(legend.position=c(0.1,0.13))+
  theme(axis.text.x=element_text(hjust=0.68))
```

---
# Determination of s1 for positive and negative correlation

```{r, fig.show='hold',out.width='50%'}
set.seed(2019)
noise <- rnorm(81,0,0.02)
set.seed(2019)
noise2 <- rnorm(81,0,0.03)
tb1 <- tibble(x=seq(0.4,0.8,length.out=81),y=x-0.2+noise)
tb2 <- tibble(x=seq(0.6,0.2,length.out=81),y=-x+1-0.2+noise)
tb1 %>% 
  ggplot()+aes(x,y)+
  geom_point()+geom_abline(linetype='dashed')+
  geom_point(aes(mean(x),mean(y)),color='red')+
  annotate('segment',x=0.6,xend=0.6,y=mean(tb1$y),yend=0.6,arrow=arrow(angle=15,ends='both',length=unit(0.2,'inches')),color='blue')+
  annotate(geom='text',x=0.75,y=0.4,label='d[1]==0.201',parse=T,size=8)+
  annotate(geom='text',x=0.75,y=0.3,label='s[1]==0.799',parse=T,size=8)+
  xlim(0,1)+ylim(0,1)+
  theme_bw(14)
tb2 %>% 
  ggplot()+aes(x,y)+
  geom_point()+geom_abline(slope=-1,intercept=1,linetype='dashed',)+
  geom_point(aes(mean(x),mean(y)),color='red')+
  annotate('segment',x=0.4,xend=0.4,y=mean(tb2$y),yend=0.6,arrow=arrow(angle=15,ends='both',length=unit(0.2,'inches')),color='blue')+
  annotate(geom='text',x=0.25,y=0.4,label='d[1]==0.201',parse=T,size=8)+
  annotate(geom='text',x=0.25,y=0.3,label='s[1]==0.799',parse=T,size=8)+
  xlim(0,1)+ylim(0,1)+
  theme_bw(14)
```

---

```{r,fig.show='hold',out.width='42%'}
library(patchwork)
library(fssim)
plotfig <- function(df,shape,slope,intercept,xloc,yloc){
  labels <- df %>% 
    summarise(s1=str_c('s[1]==',round(gcsm(x,y,fuzzy=F,comp='s1',xmin=0,xmax=1,ymin=0,ymax=1),3)),
              s2=str_c('s[2]==',round(gcsm(x,y,fuzzy=F,comp='s2',xmin=0,xmax=1,ymin=0,ymax=1),3)),
              s3=str_c('s[3]==',round(gcsm(x,y,fuzzy=F,comp='s3',xmin=0,xmax=1,ymin=0,ymax=1),3)),
              si=str_c('GCSM==',round(gcsm(x,y,fuzzy=F,comp='si',xmin=0,xmax=1,ymin=0,ymax=1),3))) %>% 
    gather(comp,label) %>% 
    mutate(x=xloc,y=seq(yloc,yloc-0.12,length.out=4))
  df %>% 
    ggplot()+aes(x,y)+
    geom_point(shape=shape)+
    geom_abline(linetype='dashed',slope=slope,intercept=intercept)+
    geom_text(aes(x,y,label=label),data=labels,parse=T,size=6)+
    # coord_cartesian(expand=F)+
    scale_x_continuous(limits=c(0,1),breaks=c(0,1),labels=c('min','max'))+
    scale_y_continuous(limits=c(0,1),breaks=c(0,1),labels=c('min','max'))
}
set.seed(2019)
noise <- rnorm(81,0,0.02)
set.seed(2019)
noise2 <- rnorm(81,0,0.03)
tb1 <- tibble(x=seq(0.4,0.8,length.out=81),y=x-0.2+noise)
tb2 <- tibble(x=seq(0.6,0.2,length.out=81),y=-x+1-0.2+noise)
tb3 <- tibble(x=seq(0.4,0.8,length.out=81),y=x*1.5-0.3+noise2)
tb4 <- tibble(x=seq(0.6,0.2,length.out=81),y=-1.5*x+1.2+noise2)

plotfig(tb1,'circle', 1,0,0.8,0.44)+
  theme_bw(14)+theme(panel.grid=element_blank())
plotfig(tb2,'circle open',-1,1,0.2,0.44)+
  theme_bw(14)+theme(panel.grid=element_blank())
plotfig(tb3,'triangle',1,0,0.55,0.94)+
  theme_bw(14)+theme(panel.grid=element_blank())
plotfig(tb4,'triangle open',-1,1,0.45,0.94)+
  theme_bw(14)+theme(panel.grid=element_blank())
```

---
# Application of fuzzy sets

$$\mu_{H}(v)=\left\{\begin{array}{ll}{0} & {\text { if } v<v_{\min }} \\ {1} & {\text { if } v>v_{\max }} \\ {\frac{v-v_{\min }}{v_{\max }-v_{\min }}} & {\text { otherwise }}\end{array}\right.$$

---
# Sensitivity test

Reference: Average Annual GPP from MPI

Distortion: Gaussian noise with different standard deviation

```{r fig.show='hold', out.width='50%'}
sens_std <- read_csv('sens_std.csv')
sens_std_rev <- read_csv('sens_std_rev.csv')
sens_std %>% 
  rename(gcsm=gcmsc) %>% 
  rename_at(vars(-(1:3)),toupper) %>% 
  gather(measure,similarity,-c(1:3)) %>% 
  mutate(measure=factor(measure,levels=c('SSIM','CMSC','GCSM'))) %>% 
  ggplot()+aes(x=std,y=similarity,color=measure)+
  geom_point(size=0.5)+
  # scale_color_grey(start=0.8,end=0.2)+
  labs(x='Standard deviation of noise',y='Similarity measure')+
  scale_x_continuous(expand=expand_scale(mult=c(0.002,0.05)))+
  scale_y_continuous(expand=expand_scale(mult=c(0.05,0.002)))+
  theme_bw(14)+
  theme(legend.title=element_blank())+
  theme(legend.position=c(0.15,0.24))
sens_std_rev %>% 
  rename(gcsm=gcmsc) %>% 
  rename_at(vars(-(1:3)),toupper) %>% 
  gather(measure,similarity,-c(1:3)) %>% 
  mutate(measure=factor(measure,levels=c('SSIM','CMSC','GCSM'))) %>% 
  ggplot()+aes(x=std,y=similarity,color=measure)+
  geom_point(size=0.5)+
  # scale_color_grey(start=0.8,end=0.2)+
  labs(x='Standard deviation of noise',y='Similarity measure')+
  scale_x_continuous(expand=expand_scale(mult=c(0.002,0.05)))+
  scale_y_continuous(expand=expand_scale(mult=c(0.002,0.05)))+
  theme_bw(14)+
  theme(legend.position=c(0.15,0.74))+
  theme(legend.title=element_blank())+
  theme(legend.background=element_blank())
```

---
# Case studies

### I: Consistency between MPI and MOD

### II: Association between GPP and precipitation

---
# Temporal GCSM between MPI and MOD

```{r}
knitr::include_graphics('tmpimod-1.png')
```

---
# Spatial GCSM between MPI and MOD

```{r}
knitr::include_graphics('smpimod-1.png')
```

---
# Temporal GCSM between GPP and rainfall

```{r}
knitr::include_graphics('tmpipre-1.png')
```

---
# Spatial GCSM between GPP and rainfall

```{r}
knitr::include_graphics('smpipre-1.png')
```

---
class: center, middle

# Thanks!
